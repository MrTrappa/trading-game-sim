<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MAC'S TRADING SIMULATOR CHALLENGE</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    body { background: #2c2c2c; color: #fff; font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
    h1 { margin: 20px; font-size: 26px; }
    #chart, #volumeChart, #rsiChart { margin: 0 auto; max-width: 95%; }
    button {
      background: #1db954; color: #fff; border: none;
      padding: 12px 20px; margin: 10px; font-size: 16px;
      border-radius: 8px; cursor: pointer; width: 140px;
      transition: background 0.3s;
    }
    button:hover { background: #1ed760; }
    #leaderboard { background: #1c1c1c; padding: 10px; margin: 20px auto; width: 90%; max-width: 300px; border-radius: 10px; }
    input, select {
      padding: 8px; margin: 10px; border-radius: 5px; border: none; width: 200px; font-size: 16px;
    }
  </style>
</head>
<body>

<h1>üéÆ MAC'S TRADING SIMULATOR CHALLENGE üí∞üìä</h1>

<input type="text" id="playerName" placeholder="Enter your name" />
<br>
<label for="modeSelect">Mode:</label>
<select id="modeSelect" onchange="handleModeChange()">
  <option value="standard">Standard (5min)</option>
  <option value="timeAttack">Time Attack (2min, 50x/100x only)</option>
</select>
<br>
<label for="leverageSelect">Leverage:</label>
<select id="leverageSelect">
  <option value="1">1x</option>
  <option value="5">5x</option>
  <option value="10" selected>10x</option>
  <option value="20">20x</option>
  <option value="50">50x</option>
  <option value="100">100x</option>
</select>

<p id="balance">Balance: $500</p>
<p id="position">Position: None</p>
<p id="unrealized">Unrealized PnL: $0</p>
<p id="timer">Time Left: 300s</p>

<div id="chart"></div>
<div id="volumeChart"></div>
<div id="rsiChart"></div>

<button onclick="startGame()">START GAME</button>
<button onclick="goLong()">GO LONG</button>
<button onclick="goShort()">GO SHORT</button>
<button onclick="closePosition()">CLOSE POSITION</button>

<div id="leaderboard">
  <h3>üèÜ Leaderboard</h3>
  <ul id="leaderboardList"></ul>
</div>

<script>
// VARIABLES
let balance = 500;
let position = null;
let timeLeft = 300;
let timerId;
let intervalId;
let gameStarted = false;
let lastClose = 1900;
let candles = [];
let volumes = [];
let rsiValues = [];
let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
let gameMode = 'standard';
let supportLevel, resistanceLevel;

// DOM refs
const balanceDisplay = document.getElementById('balance');
const positionDisplay = document.getElementById('position');
const unrealizedDisplay = document.getElementById('unrealized');
const timerDisplay = document.getElementById('timer');

// APEXCHARTS CONFIG
const chartOptions = {
  chart: { type: 'candlestick', height: 300, background: '#222' },
  series: [{ data: [] }],
  xaxis: { type: 'datetime' },
  annotations: { yaxis: [] },
  theme: { mode: 'dark' }
};
const volumeOptions = {
  chart: { type: 'bar', height: 120, background: '#333' },
  series: [{ name: 'Volume', data: [] }],
  xaxis: { type: 'datetime', labels: { show: false } },
  theme: { mode: 'dark' }
};
const rsiOptions = {
  chart: { type: 'line', height: 120, background: '#333' },
  series: [{ name: 'RSI', data: [] }],
  xaxis: { type: 'datetime', labels: { show: false } },
  yaxis: { min: 0, max: 100 },
  theme: { mode: 'dark' }
};

const chart = new ApexCharts(document.querySelector("#chart"), chartOptions);
const volumeChart = new ApexCharts(document.querySelector("#volumeChart"), volumeOptions);
const rsiChart = new ApexCharts(document.querySelector("#rsiChart"), rsiOptions);
chart.render();
volumeChart.render();
rsiChart.render();

// HELPERS
function generateNextCandle(prevClose) {
  const open = prevClose;
  const high = open + Math.random() * 2;
  const low = open - Math.random() * 2;
  const close = low + Math.random() * (high - low);
  return { y: [open, high, low, close] };
}
function calculateRSI(closes) {
  if (closes.length < 15) return 50;
  let gains = 0, losses = 0;
  for (let i = closes.length - 14; i < closes.length; i++) {
    const diff = closes[i] - closes[i-1];
    if (diff >= 0) gains += diff;
    else losses -= diff;
  }
  const rs = gains / (losses || 1);
  return 100 - (100 / (1 + rs));
}
function generateHistory(startPrice, numCandles) {
  let data = [], vols = [], rsis = [];
  let prev = startPrice;
  let closes = [prev];
  let time = new Date(Date.now() - numCandles * 60000);
  for (let i = 0; i < numCandles; i++) {
    const candle = generateNextCandle(prev);
    candle.x = new Date(time.getTime() + i * 60000);
    data.push(candle);
    const volume = Math.floor(100 + Math.abs(candle.y[3]-candle.y[0])*50);
    vols.push({ x: candle.x, y: volume });
    closes.push(candle.y[3]);
    const rsiVal = calculateRSI(closes);
    rsis.push({ x: candle.x, y: rsiVal });
    prev = candle.y[3];
  }
  supportLevel = Math.min(...data.map(c => c.y[2])) - 0.5;
  resistanceLevel = Math.max(...data.map(c => c.y[1])) + 0.5;
  lastClose = prev;
  return { candles: data, volumes: vols, rsi: rsis };
}

// BUTTONS
function startGame() {
  const name = document.getElementById('playerName').value.trim();
  if (!name) { alert("Enter your name!"); return; }
  clearInterval(intervalId); clearTimeout(timerId);
  gameStarted = true; balance = 500;
  timeLeft = (gameMode === 'timeAttack') ? 120 : 300;
  position = null;
  const history = generateHistory(1900, 120);
  candles = history.candles;
  volumes = history.volumes;
  rsiValues = history.rsi;
  chart.updateSeries([{ data: candles }]);
  volumeChart.updateSeries([{ data: volumes }]);
  rsiChart.updateSeries([{ data: rsiValues }]);
  chart.updateOptions({
    annotations: { yaxis: [
      { y: supportLevel, borderColor: '#0f0', label: { text: 'Support', style: { background: '#0f0', color: '#000' } } },
      { y: resistanceLevel, borderColor: '#f00', label: { text: 'Resistance', style: { background: '#f00', color: '#000' } } }
    ]}
  });
  balanceDisplay.textContent = `Balance: $${balance.toFixed(2)}`;
  positionDisplay.textContent = `Position: None`;
  unrealizedDisplay.textContent = `Unrealized PnL: $0`;
  timerDisplay.textContent = `Time Left: ${timeLeft}s`;
  intervalId = setInterval(updateChart, 3000);
  countdown();
}
function updateChart() {
  const nextCandle = generateNextCandle(lastClose);
  const lastTime = candles[candles.length-1].x;
  nextCandle.x = new Date(lastTime.getTime() + 60000);
  candles.push(nextCandle);
  chart.updateSeries([{ data: candles }]);
  const volume = Math.floor(100 + Math.abs(nextCandle.y[3]-nextCandle.y[0])*50);
  volumes.push({ x: nextCandle.x, y: volume });
  volumeChart.updateSeries([{ data: volumes }]);
  const closes = candles.map(c => c.y[3]);
  const rsiVal = calculateRSI(closes);
  rsiValues.push({ x: nextCandle.x, y: rsiVal });
  rsiChart.updateSeries([{ data: rsiValues }]);
  lastClose = nextCandle.y[3];
}
function handleModeChange() {
  const mode = document.getElementById('modeSelect').value;
  gameMode = mode;
  const leverageSelect = document.getElementById('leverageSelect');
  leverageSelect.innerHTML = '';
  if (mode === 'timeAttack') {
    leverageSelect.innerHTML += '<option value="50">50x</option><option value="100">100x</option>';
  } else {
    leverageSelect.innerHTML += '<option value="1">1x</option><option value="5">5x</option><option value="10" selected>10x</option><option value="20">20x</option><option value="50">50x</option><option value="100">100x</option>';
  }
}
</script>

</body>
</html>
