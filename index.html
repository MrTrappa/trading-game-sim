<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trading Simulator with ApexCharts</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    body { background: #121212; color: #fff; font-family: sans-serif; text-align: center; }
    #chart { margin: 0 auto; }
    button {
      background: #1db954; color: #fff; border: none;
      padding: 12px 20px; margin: 10px; font-size: 16px;
      border-radius: 8px; cursor: pointer;
    }
  </style>
</head>
<body>

<h1>ðŸ“ˆ XAU/USD Trading Simulator</h1>
<p id="balance">Balance: $500</p>
<p id="position">Position: None</p>
<p id="unrealized">Unrealized PnL: $0</p>
<p id="timer">Time Left: 300s</p>

<div id="chart"></div>

<button onclick="startGame()">START GAME</button>
<button onclick="goLong()">GO LONG</button>
<button onclick="goShort()">GO SHORT</button>
<button onclick="closePosition()">CLOSE POSITION</button>

<script>
let balance = 500;
let position = null;
let leverage = 10;
let timeLeft = 300;
let timerId;
let intervalId;
let gameStarted = false;
let lastClose = 1900;
let candles = [];

const balanceDisplay = document.getElementById('balance');
const positionDisplay = document.getElementById('position');
const unrealizedDisplay = document.getElementById('unrealized');
const timerDisplay = document.getElementById('timer');

const options = {
  chart: { type: 'candlestick', height: 400, background: '#222' },
  series: [{ data: [] }],
  xaxis: { type: 'datetime' },
  theme: { mode: 'dark' }
};
const chart = new ApexCharts(document.querySelector("#chart"), options);
chart.render();

function generateNextCandle(prevClose) {
  const open = prevClose;
  const high = open + Math.random() * 2;
  const low = open - Math.random() * 2;
  const close = low + Math.random() * (high - low);
  return { x: new Date(), y: [open, high, low, close] };
}

function startGame() {
  if (intervalId) clearInterval(intervalId);
  if (timerId) clearTimeout(timerId);

  gameStarted = true;
  balance = 500;
  timeLeft = 300;
  position = null;
  lastClose = 1900;
  candles = [];

  balanceDisplay.textContent = `Balance: $${balance.toFixed(2)}`;
  positionDisplay.textContent = `Position: None`;
  unrealizedDisplay.textContent = `Unrealized PnL: $0`;
  timerDisplay.textContent = `Time Left: ${timeLeft}s`;

  chart.updateSeries([{ data: [] }]);

  intervalId = setInterval(updateChart, 3000);
  countdown();
}

function updateChart() {
  const nextCandle = generateNextCandle(lastClose);
  candles.push(nextCandle);
  chart.updateSeries([{ data: candles }]);
  lastClose = nextCandle.y[3];
  updateUnrealizedPnL();
}

function getCurrentPrice() {
  return lastClose;
}

function goLong() {
  if (!gameStarted) return;
  if (!position) {
    position = { type: 'LONG', entryPrice: getCurrentPrice() };
    positionDisplay.textContent = `Position: LONG @ $${position.entryPrice.toFixed(2)}`;
  } else { alert('Already holding a position!'); }
}

function goShort() {
  if (!gameStarted) return;
  if (!position) {
    position = { type: 'SHORT', entryPrice: getCurrentPrice() };
    positionDisplay.textContent = `Position: SHORT @ $${position.entryPrice.toFixed(2)}`;
  } else { alert('Already holding a position!'); }
}

function closePosition() {
  if (!gameStarted) return;
  if (position) {
    const exitPrice = getCurrentPrice();
    let profit = 0;
    if (position.type === 'LONG') {
      profit = (exitPrice - position.entryPrice) * leverage;
    } else {
      profit = (position.entryPrice - exitPrice) * leverage;
    }
    balance += profit;
    balanceDisplay.textContent = `Balance: $${balance.toFixed(2)}`;
    alert(`Closed ${position.type} for ${profit >= 0 ? '+' : ''}${profit.toFixed(2)}`);
    position = null;
    positionDisplay.textContent = `Position: None`;
    unrealizedDisplay.textContent = `Unrealized PnL: $0`;
  } else { alert('No open position!'); }
}

function updateUnrealizedPnL() {
  if (position) {
    const currentPrice = getCurrentPrice();
    let pnl = 0;
    if (position.type === 'LONG') {
      pnl = (currentPrice - position.entryPrice) * leverage;
    } else {
      pnl = (position.entryPrice - currentPrice) * leverage;
    }
    unrealizedDisplay.textContent = `Unrealized PnL: $${pnl.toFixed(2)}`;
  } else {
    unrealizedDisplay.textContent = `Unrealized PnL: $0`;
  }
}

function countdown() {
  if (timeLeft <= 0) {
    clearInterval(intervalId);
    alert(`Game Over!\nFinal Balance: $${balance.toFixed(2)}`);
  } else {
    timeLeft--;
    timerDisplay.textContent = `Time Left: ${timeLeft}s`;
    timerId = setTimeout(countdown, 1000);
  }
}
</script>

</body>
</html>
