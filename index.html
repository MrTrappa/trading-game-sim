<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MAC'S TRADING SIMULATOR CHALLENGE</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    body { background: #2c2c2c; color: #fff; font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
    h1 { margin: 20px; font-size: 26px; }
    #chart { margin: 0 auto; max-width: 90%; }
    button {
      background: #1db954; color: #fff; border: none;
      padding: 12px 20px; margin: 10px; font-size: 16px;
      border-radius: 8px; cursor: pointer; width: 140px;
      transition: background 0.3s;
    }
    button:hover { background: #1ed760; }
    #leaderboard { background: #1c1c1c; padding: 10px; margin: 20px auto; width: 90%; max-width: 300px; border-radius: 10px; }
    input, select {
      padding: 8px; margin: 10px; border-radius: 5px; border: none; width: 200px; font-size: 16px;
    }
  </style>
</head>
<body>

<h1>üéÆ MAC'S TRADING SIMULATOR CHALLENGE üí∞üìä</h1>

<input type="text" id="playerName" placeholder="Enter your name" />
<br>
<label for="leverageSelect">Leverage:</label>
<select id="leverageSelect">
  <option value="1">1x</option>
  <option value="5">5x</option>
  <option value="10" selected>10x</option>
  <option value="20">20x</option>
  <option value="50">50x</option>
  <option value="100">100x</option>
</select>

<p id="balance">Balance: $500</p>
<p id="position">Position: None</p>
<p id="unrealized">Unrealized PnL: $0</p>
<p id="timer">Time Left: 300s</p>

<div id="chart"></div>

<button onclick="startGame()">START GAME</button>
<button onclick="goLong()">GO LONG</button>
<button onclick="goShort()">GO SHORT</button>
<button onclick="closePosition()">CLOSE POSITION</button>

<div id="leaderboard">
  <h3>üèÜ Leaderboard</h3>
  <ul id="leaderboardList"></ul>
</div>

<!-- SOUND EFFECTS -->
<audio id="buySound" src="https://www.soundjay.com/button/sounds/button-3.mp3"></audio>
<audio id="sellSound" src="https://www.soundjay.com/button/sounds/button-4.mp3"></audio>
<audio id="closeSound" src="https://www.soundjay.com/button/sounds/button-10.mp3"></audio>

<script>
let balance = 500;
let position = null;
let timeLeft = 300;
let timerId;
let intervalId;
let gameStarted = false;
let lastClose = 1900;
let candles = [];
let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];

const balanceDisplay = document.getElementById('balance');
const positionDisplay = document.getElementById('position');
const unrealizedDisplay = document.getElementById('unrealized');
const timerDisplay = document.getElementById('timer');
const leaderboardList = document.getElementById('leaderboardList');
const buySound = document.getElementById('buySound');
const sellSound = document.getElementById('sellSound');
const closeSound = document.getElementById('closeSound');

const options = {
  chart: { type: 'candlestick', height: 400, background: '#222' },
  series: [{ data: [] }],
  xaxis: { type: 'datetime' },
  theme: { mode: 'dark' }
};
const chart = new ApexCharts(document.querySelector("#chart"), options);
chart.render();

function generateNextCandle(prevClose) {
  const open = prevClose;
  const high = open + Math.random() * 2;
  const low = open - Math.random() * 2;
  const close = low + Math.random() * (high - low);
  return { x: new Date(), y: [open, high, low, close] };
}

function startGame() {
  const name = document.getElementById('playerName').value.trim();
  if (name === "") { alert("Please enter your name!"); return; }

  if (intervalId) clearInterval(intervalId);
  if (timerId) clearTimeout(timerId);

  gameStarted = true;
  balance = 500;
  timeLeft = 300;
  position = null;
  lastClose = 1900;
  candles = [];

  balanceDisplay.textContent = `Balance: $${balance.toFixed(2)}`;
  positionDisplay.textContent = `Position: None`;
  unrealizedDisplay.textContent = `Unrealized PnL: $0`;
  timerDisplay.textContent = `Time Left: ${timeLeft}s`;

  chart.updateSeries([{ data: [] }]);

  intervalId = setInterval(updateChart, 3000);
  countdown();
}

function updateChart() {
  const nextCandle = generateNextCandle(lastClose);
  candles.push(nextCandle);
  chart.updateSeries([{ data: candles }]);
  lastClose = nextCandle.y[3];
  updateUnrealizedPnL();
}

function getCurrentPrice() { return lastClose; }

function goLong() {
  if (!gameStarted) return;
  if (!position) {
    const leverage = parseInt(document.getElementById('leverageSelect').value);
    position = { type: 'LONG', entryPrice: getCurrentPrice(), leverageUsed: leverage };
    positionDisplay.textContent = `Position: LONG @ $${position.entryPrice.toFixed(2)} (Leverage ${leverage}x)`;
    buySound.play();
  } else { alert('Already holding a position!'); }
}

function goShort() {
  if (!gameStarted) return;
  if (!position) {
    const leverage = parseInt(document.getElementById('leverageSelect').value);
    position = { type: 'SHORT', entryPrice: getCurrentPrice(), leverageUsed: leverage };
    positionDisplay.textContent = `Position: SHORT @ $${position.entryPrice.toFixed(2)} (Leverage ${leverage}x)`;
    sellSound.play();
  } else { alert('Already holding a position!'); }
}

function closePosition() {
  if (!gameStarted) return;
  if (position) {
    const exitPrice = getCurrentPrice();
    let profit = 0;
    if (position.type === 'LONG') {
      profit = (exitPrice - position.entryPrice) * position.leverageUsed;
    } else {
      profit = (position.entryPrice - exitPrice) * position.leverageUsed;
    }
    balance += profit;
    balanceDisplay.textContent = `Balance: $${balance.toFixed(2)}`;
    alert(`Closed ${position.type} for ${profit >= 0 ? '+' : ''}${profit.toFixed(2)} (Leverage ${position.leverageUsed}x)`);
    position = null;
    positionDisplay.textContent = `Position: None`;
    unrealizedDisplay.textContent = `Unrealized PnL: $0`;
    closeSound.play();
  } else { alert('No open position!'); }
}

function updateUnrealizedPnL() {
  if (position) {
    const currentPrice = getCurrentPrice();
    let pnl = 0;
    if (position.type === 'LONG') pnl = (currentPrice - position.entryPrice) * position.leverageUsed;
    else pnl = (position.entryPrice - currentPrice) * position.leverageUsed;
    unrealizedDisplay.textContent = `Unrealized PnL: $${pnl.toFixed(2)} (Leverage ${position.leverageUsed}x)`;
  } else {
    unrealizedDisplay.textContent = `Unrealized PnL: $0`;
  }
}

function countdown() {
  if (timeLeft <= 0) {
    clearInterval(intervalId);
    alert(`Game Over!\nFinal Balance: $${balance.toFixed(2)}`);
    saveToLeaderboard(balance, document.getElementById('playerName').value.trim());
  } else {
    timeLeft--;
    timerDisplay.textContent = `Time Left: ${timeLeft}s`;
    timerId = setTimeout(countdown, 1000);
  }
}

function saveToLeaderboard(finalBalance, name) {
  leaderboard.push({ name, balance: finalBalance });
  leaderboard.sort((a,b) => b.balance - a.balance);
  leaderboard = leaderboard.slice(0,5);
  localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
  renderLeaderboard();
}

function renderLeaderboard() {
  leaderboardList.innerHTML = '';
  leaderboard.forEach((entry, index) => {
    const li = document.createElement('li');
    li.textContent = `#${index+1}: ${entry.name} - $${entry.balance.toFixed(2)}`;
    leaderboardList.appendChild(li);
  });
}

renderLeaderboard();
</script>

</body>
</html>
